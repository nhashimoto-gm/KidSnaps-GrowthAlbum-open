# 動画サムネイル機能マイグレーションガイド

## 概要

.movファイルを含む動画ファイルのサムネイル表示と再生機能を改善しました。

## 実施内容

### 1. データベース変更

`media_files`テーブルに`thumbnail_path`カラムを追加しました。

### 2. 機能追加

- クライアント側での動画サムネイル自動生成
- サムネイル画像の保存と表示
- 動画プレーヤーの互換性改善
- ブラウザがサポートしていない場合のフォールバック機能

## マイグレーション手順

### ステップ1: データベースの更新

既存のデータベースに`thumbnail_path`カラムを追加します。

```bash
# MySQLにログイン
mysql -u [ユーザー名] -p [データベース名]

# または.env_dbから接続情報を取得して実行
mysql -u $(grep DB_USER .env_db | cut -d '=' -f2) -p$(grep DB_PASSWORD .env_db | cut -d '=' -f2) $(grep DB_NAME .env_db | cut -d '=' -f2) < sql/add_thumbnail_column.sql
```

または、以下のSQLを直接実行：

```sql
ALTER TABLE media_files
ADD COLUMN thumbnail_path VARCHAR(500) DEFAULT NULL COMMENT 'サムネイル画像パス（動画用）'
AFTER file_size;
```

### ステップ2: ディレクトリの確認

サムネイル保存用のディレクトリが作成されていることを確認します。

```bash
ls -la uploads/thumbnails/
```

ディレクトリが存在しない場合は作成します：

```bash
mkdir -p uploads/thumbnails
chmod 755 uploads/thumbnails
```

### ステップ3: 動作確認

1. ブラウザで`index.php`にアクセス
2. .movファイルまたは他の動画ファイルをアップロード
3. サムネイルが自動生成されることを確認
4. ギャラリーページでサムネイルが表示されることを確認
5. 動画をクリックして再生できることを確認

## ブラウザ互換性

### サポート対象

- Chrome/Edge: 完全サポート
- Firefox: 完全サポート
- Safari: 完全サポート（.movファイルを含む）

### .movファイルについて

QuickTime形式（.mov）は以下の方法で処理されます：

1. **アップロード時**: クライアント側のJavaScriptで動画の1秒後のフレームからサムネイルを自動生成
2. **ギャラリー表示**: 生成されたサムネイル画像を表示（画像として表示されるため高速）
3. **再生**: HTMLの`<video>`タグで再生（ブラウザがサポートしている場合）

### トラブルシューティング

#### サムネイルが生成されない場合

1. ブラウザのコンソールを開いてエラーを確認
2. 動画ファイルが破損していないか確認
3. ブラウザが動画形式をサポートしているか確認

#### 動画が再生できない場合

1. サムネイルは表示されるが再生できない → ブラウザが動画コーデックをサポートしていない可能性
   - 解決策: ダウンロードボタンから動画をダウンロードして別のプレーヤーで再生
2. 「ダウンロード」リンクが表示される → 正常な動作（ブラウザがサポートしていない形式）

## ロールバック方法

この機能を元に戻す場合：

```sql
-- thumbnail_pathカラムを削除
ALTER TABLE media_files DROP COLUMN thumbnail_path;
```

その後、以下のファイルを元のバージョンに戻してください：
- `index.php`
- `upload.php`
- `assets/js/script.js`
- `sql/setup.sql`

## 注意事項

- 既存の動画ファイルにはサムネイルがありません（再アップロードが必要）
- サムネイル生成はクライアント側で行われるため、ブラウザのサポートに依存します
- サムネイル画像は動画ファイルとは別に保存されます（`uploads/thumbnails/`）
- 動画を削除してもサムネイルは自動削除されません（将来的な改善点）

## サポート

問題が発生した場合は、以下を確認してください：

1. ブラウザのコンソールログ
2. PHPのエラーログ
3. データベースのスキーマ（`thumbnail_path`カラムが存在するか）
4. ディレクトリのパーミッション（`uploads/thumbnails/`が書き込み可能か）
