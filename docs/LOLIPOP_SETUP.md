# Lolipopレンタルサーバーでのセットアップガイド

このドキュメントは、KidSnaps Growth AlbumをLolipop!レンタルサーバーで運用するための設定手順を説明します。

## 目次
- [Lolipop固有の制約](#lolipop固有の制約)
- [セットアップ手順](#セットアップ手順)
- [トラブルシューティング](#トラブルシューティング)
- [注意事項](#注意事項)

---

## Lolipop固有の環境情報

### 推奨環境
- **PHPバージョン**: PHP 8.3（LiteSpeed版）
- **Webサーバー**: LiteSpeed
- **プラン**: スタンダード以上推奨（100MBアップロード対応）

### PHP版による違い

Lolipopでは複数のPHP実行方式があります：

#### ✅ LiteSpeed版PHP（推奨・最新）
- **対応バージョン**: PHP 8.3, 8.2, 8.1
- **設定方法**: `.htaccess`で直接設定可能（`<IfModule mod_lsapi.c>`）
- **パフォーマンス**: 高速
- **本プロジェクトの対応**: ✅ 完全対応

#### ⚠️ CGI版/FastCGI版PHP（旧方式）
- **設定方法**: `.user.ini`ファイルで設定
- **パフォーマンス**: 標準
- **本プロジェクトの対応**: ✅ フォールバック対応

### 共通の制約

Lolipop!レンタルサーバーは共有サーバー環境のため、以下の制約があります：

#### 1. サーバーディレクティブ
- ❌ `ServerSignature`などの一部のApacheディレクティブが使用不可
- ✅ セキュリティヘッダーは`<IfModule mod_headers.c>`で設定可能

#### 2. 一時ディレクトリ
- ❌ システムの一時ディレクトリ（`sys_get_temp_dir()`）に書き込み不可
- ✅ プロジェクト内のディレクトリ（`uploads/temp/`）を使用

---

## セットアップ手順

### 1. ファイルのアップロード

FTPクライアント（FileZillaなど）を使用して、全ファイルをサーバーにアップロードします。

```
アップロード先: /（ルートディレクトリ）または /public_html/
```

**重要なファイル:**
- `.user.ini` - PHP設定ファイル（必須）
- `.htaccess` - セキュリティ設定（必須）
- `config/database.php` - データベース接続設定

### 2. PHP設定の確認

#### LiteSpeed版PHP 8.3の場合（推奨）

`.htaccess`にPHP設定が含まれているため、追加の設定は不要です。

```apache
# .htaccess内に以下の設定が含まれています
<IfModule mod_lsapi.c>
    php_value upload_max_filesize 100M
    php_value post_max_size 100M
    php_value max_execution_time 600
    php_value max_input_time 600
    php_value memory_limit 256M
    php_flag display_errors Off
    php_flag log_errors On
</IfModule>
```

**確認方法:**
1. Lolipop!ユーザー専用ページ → 「PHP設定」
2. PHP版が「LiteSpeed」になっていることを確認
3. PHPバージョンが8.1以上であることを確認

#### CGI版/FastCGI版の場合

`.user.ini`ファイルがプロジェクトルートに存在することを確認してください（既にアップロード済み）。

**注意:**
- `.user.ini`の変更が反映されるまで数分かかる場合があります
- LiteSpeed版では`.htaccess`の設定が優先されます
- ファイルサイズ制限はプランによって上限が異なります

### 3. データベースの作成

Lolipop!ユーザー専用ページから：

1. **データベース作成**
   - 「サーバーの管理・設定」→「データベース」→「作成」
   - データベース名、ユーザー名、パスワードを設定

2. **テーブル作成**
   - phpMyAdminにログイン
   - 作成したデータベースを選択
   - 「インポート」タブから`sql/setup.sql`をインポート

### 4. データベース接続設定

`.env_db.example`をコピーして`.env_db`を作成し、Lolipopのデータベース情報を設定：

```bash
# FTPクライアントで.env_db.exampleをダウンロード
# ローカルで編集して.env_dbとして保存
# .env_dbをサーバーにアップロード
```

`.env_db`の内容：

```ini
DB_HOST=mysql000.lolipop.jp  # Lolipopのデータベースサーバー
DB_NAME=LA12345678-database  # 作成したデータベース名
DB_USER=LA12345678          # データベースユーザー名
DB_PASS=your_password       # 設定したパスワード
```

**データベース接続情報の確認方法:**
- Lolipop!ユーザー専用ページ
- 「サーバーの管理・設定」→「データベース」
- 作成したデータベースの「詳細」をクリック

### 5. ディレクトリパーミッション設定

FTPクライアントで以下のディレクトリのパーミッションを変更：

```
uploads/           → 755
uploads/images/    → 755
uploads/videos/    → 755
uploads/thumbnails/→ 755
uploads/temp/      → 755（初回アップロード時に自動作成されます）
```

### 6. アクセス確認

ブラウザでアクセスして動作を確認：

```
https://your-domain.com/
または
https://your-subdomain.lolipop.jp/
```

---

## トラブルシューティング

### 問題1: ファイルサイズの上限エラー

**症状:**
```
ファイルサイズは100MB以下にしてください。
```

**原因:**
- Lolipopプランによるアップロードサイズ制限
- PHP設定が正しく反映されていない

**解決策（LiteSpeed版PHP 8.3の場合）:**
1. Lolipopプランの上限を確認（エコノミー: 5MB、ライト: 10MB、スタンダード以上: 100MB+）
2. `.htaccess`の`<IfModule mod_lsapi.c>`ブロックが存在することを確認
3. Lolipop管理画面で「LiteSpeed版PHP」が選択されているか確認
4. プラン変更を検討（より大きなファイルをアップロードする場合）

**解決策（CGI版/FastCGI版の場合）:**
1. `.user.ini`ファイルが正しくアップロードされているか確認
2. 設定反映まで5-10分程度待つ
3. Lolipop管理画面からPHP設定を確認

### 問題2: 500 Internal Server Error

**症状:**
```
500 Internal Server Error
```

**原因:**
- `.htaccess`に互換性のないディレクティブが含まれている
- PHPエラーが発生している
- PHP版の設定が正しくない

**解決策:**
1. `.htaccess`の`ServerSignature Off`がコメントアウトされているか確認
2. LiteSpeed版PHPを使用している場合、`<IfModule mod_lsapi.c>`が正しく記述されているか確認
3. エラーログを確認（Lolipop!ユーザー専用ページ → 「ログ」）
4. 一時的にPHPエラーを表示する（`.htaccess`または`.user.ini`で`display_errors = On`に設定）

### 問題3: セッションエラー

**症状:**
```
アップロードされたファイルが見つかりません。
```

**原因:**
- セッションが正しく保存されていない
- セッションのタイムアウト

**解決策:**
1. `.user.ini`のセッション設定を確認
2. ファイルアップロード後、速やかに処理を完了させる
3. ブラウザのCookieが有効になっているか確認

### 問題4: 一時ディレクトリへの書き込みエラー

**症状:**
```
チャンクの保存に失敗しました。
```

**原因:**
- `uploads/temp/`ディレクトリのパーミッション不足

**解決策:**
1. `uploads/`ディレクトリのパーミッションを755に設定
2. `uploads/temp/`が自動作成されない場合、手動で作成（パーミッション755）

### 問題5: 動画アップロード時のタイムアウト

**症状:**
- アップロード中に処理が止まる
- タイムアウトエラー

**原因:**
- `max_execution_time`の制限
- ネットワーク接続の不安定

**解決策:**
1. `.user.ini`の`max_execution_time`を確認（600秒に設定）
2. より安定したネットワーク環境でアップロード
3. ファイルサイズを小さくする（100MB以下推奨）

---

## 注意事項

### セキュリティ

1. **`.env_db`ファイルの保護**
   - `.htaccess`により外部からのアクセスが制限されています
   - 念のため、パーミッションを600に設定することを推奨

2. **アップロードディレクトリ**
   - `uploads/`配下ではPHPの実行が禁止されています
   - `.htaccess`ファイルを削除しないでください

3. **HTTPS接続**
   - Lolipopでは無料SSL証明書（Let's Encrypt）が利用可能
   - HTTPS接続を有効にすることを強く推奨

### パフォーマンス

1. **チャンク分割アップロード**
   - 大きなファイルは1MBずつ分割してアップロードされます
   - ネットワーク環境によっては時間がかかる場合があります

2. **一時ファイルのクリーンアップ**
   - アップロード失敗時、`uploads/temp/chunked_uploads/`に一時ファイルが残る場合があります
   - 定期的に古いファイルを削除してください

### プランごとの推奨設定

| プラン | ファイルサイズ上限 | 推奨設定 |
|--------|-------------------|----------|
| エコノミー | 5MB | `upload_max_filesize = 5M` |
| ライト | 10MB | `upload_max_filesize = 10M` |
| スタンダード | 100MB | `upload_max_filesize = 100M` |
| ハイスピード | 100MB以上 | `upload_max_filesize = 100M` |
| エンタープライズ | 100MB以上 | `upload_max_filesize = 100M` |

---

## デバッグ方法

### アップロードログの確認

iPhoneから動画がアップロードできない場合、詳細なログを確認できます。

#### 1. デバッグページにアクセス

ブラウザで以下のURLにアクセス：

```
https://your-domain.com/debug_logs.php?pass=debug2024
```

**セキュリティ上の注意:**
- デフォルトのパスワードは `debug2024` です
- 本番環境では必ず `debug_logs.php` の23行目でパスワードを変更してください
- 使用後は必ずファイルを削除またはアクセス制限をかけてください

#### 2. ログの見方

デバッグページには以下の情報が表示されます：

- **📤 アップロードデバッグログ**: チャンクアップロードの詳細ログ
- **⚠️ PHPエラーログ**: PHPの実行時エラー
- **🖥️ システム情報**: PHP設定とディレクトリの状態
- **🔐 セッション情報**: アップロード中のファイル情報

#### 3. よくあるエラーパターン

##### エラーコード 1: ファイルサイズ超過
```
チャンクファイルのアップロードに失敗しました。エラーコード: 1
```
→ `upload_max_filesize` または `post_max_size` を増やす必要があります

##### エラーコード 2: 一時ディレクトリへの書き込み失敗
```
チャンクの保存に失敗しました。
```
→ `uploads/temp/` ディレクトリのパーミッションを755に設定してください

##### セッションエラー
```
アップロードされたファイルが見つかりません。
```
→ セッションが切れている可能性があります。ブラウザのCookieを確認してください

#### 4. ログファイルの場所

サーバー上の以下のファイルに直接アクセスすることもできます（FTP経由）：

- `uploads/temp/upload_debug.log` - アップロードの詳細ログ
- `uploads/temp/php_error.log` - PHPエラーログ

### iPhone特有の問題

#### 「サムネイル生成中...」で止まる場合

**症状:**
動画アップロード時に「サムネイル生成中...」のまま進まない

**原因:**
- iOSのブラウザでは動画のメタデータ読み込みが不安定な場合があります
- 動画のコーデック（HEVC/H.265）がサポートされていない

**解決策:**

1. **ブラウザの開発者ツールでログを確認**
   - Safari: 設定 → Safari → 詳細 → Web インスペクタ（オン）
   - PCのSafariから「開発」→ iPhoneのデバイス名 → ページ名
   - コンソールに `[サムネイル生成]` のログが表示されます

2. **30秒待つ**
   - タイムアウトが設定されており、30秒後に自動的にスキップされます
   - サムネイルなしでアップロードが続行されます

3. **動画を再エンコード**
   - H.264コーデックのMP4に変換してください
   - iPhone標準カメラアプリの「互換性優先」モードで撮影

4. **別のブラウザを試す**
   - Chrome（iOS版）
   - Firefox（iOS版）

#### 大きな動画がアップロードできない場合

1. **ネットワーク接続を確認**
   - Wi-Fi接続を推奨（モバイル回線は不安定な場合があります）
   - Safari以外のブラウザ（Chrome、Firefox）も試してください

2. **iOSのバージョンを確認**
   - iOS 13以降を推奨
   - 古いバージョンではチャンクアップロードに対応していない場合があります

3. **ブラウザのキャッシュをクリア**
   - Safari: 設定 → Safari → 履歴とWebサイトデータを消去

4. **動画のフォーマット**
   - H.264コーデックのMP4を推奨
   - HEVCフォーマット（H.265）は一部環境で問題が発生する場合があります

---

## サポート

Lolipop固有の問題については：
- [Lolipop!サポート](https://lolipop.jp/support/)
- [よくある質問](https://lolipop.jp/manual/)

アプリケーション自体の問題については：
- GitHubのIssuesセクション

デバッグログを確認しても解決しない場合：
- デバッグログの内容をコピーして報告してください
- iPhone/iPadの機種とiOSバージョンを明記してください
- 使用しているブラウザの種類とバージョンを明記してください

---

**最終更新:** 2025年11月9日
